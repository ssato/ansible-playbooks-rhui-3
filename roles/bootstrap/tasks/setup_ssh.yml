---
- name: Check if ssh key was generated before
  command: "test -f ~/.ssh/id_rsa"
  ignore_errors: true
  changed_when: false
  register: ssh_key_found

- name: Generate ssh key
  command: "ssh-keygen -t rsa -P '' -f ~/.ssh/id_rsa"
  when:
    - ssh_key_found|failed

- name: Transfer ssh pub key
  command: "ssh-copy-id -f {{ item }}"
  loop: "{{ groups['cds'] }}"
  when:
    - use_ssh_tunnel is defined
    - use_ssh_tunnel

- name: Add ssh authorized key
  authorized_keys:
    user: root
    key: "{{ lookup('file', '~/.ssh/id_rsa.pub') }}"

# vim:sw=2:ts=2:et:
